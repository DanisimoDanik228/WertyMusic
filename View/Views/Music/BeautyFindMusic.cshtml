@model IEnumerable<Domain.Models.Music>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –ø–µ—Å–µ–Ω</title>
</head>
<body>
<div class="container">

    <div class="header">
        <h1 class="page-title">–ü–æ–∏—Å–∫ –ø–µ—Å–µ–Ω</h1>
        <div class="nav-links">
            <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="/Music/AllMusics">üìÄ –í—Å–µ –ø–µ—Å–Ω–∏</a>
        </div>
    </div>

    <div class="search-box">
        <div class="search-form">
            <input id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è..." />
            <button id="btnSearch">üîç –ù–∞–π—Ç–∏</button>
        </div>
    </div>

    <div id="resultsInfo" class="results-info">
        –ù–∞–π–¥–µ–Ω–æ –ø–µ—Å–µ–Ω: <strong id="totalCount">0</strong>
        <span id="loadingStatus" class="status-badge">
            <span class="spinner"></span> –ü–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...
        </span>
    </div>

    <div class="search-page">
        <table id="musicTable" class="music-table">
            <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                <th>–†–µ—Å—É—Ä—Å</th>
                <th>–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ</th>
            </tr>
            </thead>
            <tbody id="musicTableBody">
            </tbody>
        </table>
    </div>

    <div id="downloadAllSection" class="download-all">
        <form asp-action="DownloadZip" method="post">
            <input type="hidden" name="connectionId" id="hiddenConnectionId" />
            <button type="submit" >
                üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ (<span id="btnCount">0</span>)
            </button>
        </form>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/musicHub")
        .build();

    let musicCount = 0;

    connection.on("ReceiveMusic", function (song) {
        musicCount++;
        
        document.getElementById("resultsInfo").style.display = "block";
        document.getElementById("musicTable").style.display = "table";
        document.getElementById("downloadAllSection").style.display = "block";
        document.getElementById("totalCount").innerText = musicCount;
        document.getElementById("btnCount").innerText = musicCount;

        const tbody = document.getElementById("musicTableBody");
        const row = `
            <tr>
                <td class="music-name">${song.musicName}</td>
                <td class="artist-name">${song.artistName}</td>
                <td class="source-name">${song.siteSource}</td>
                <td>
                    <a href="${song.downloadUrl}" class="download-link" target="_blank" rel="noopener noreferrer">–°–∫–∞—á–∞—Ç—å</a>
                </td>
            </tr>`;
        
        tbody.insertAdjacentHTML('beforeend', row);
    });

    connection.on("SearchFinished", function () {
        document.getElementById("loadingStatus").innerHTML = "‚úÖ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω";
    });

    connection.on("ReceiveError", function (message) {
        alert("–û—à–∏–±–∫–∞: " + message);
        document.getElementById("loadingStatus").innerHTML = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ";
    });
    
    connection.start().then(function () {
        console.log("SignalR Connected");
        document.getElementById("hiddenConnectionId").value = connection.connectionId;
    }).catch(err => console.error(err.toString()));
    
    document.getElementById("btnSearch").addEventListener("click", function () {
        const query = document.getElementById("searchInput").value;
        if (!query) return alert("Input song name");

        const connectionId = connection.connectionId;
        if (!connectionId) return alert("Connection establishment, wait...");

        
        musicCount = 0;
        document.getElementById("totalCount").innerText = musicCount;
        document.getElementById("musicTableBody").innerHTML = "";
        document.getElementById("resultsInfo").style.display = "block";
        document.getElementById("loadingStatus").innerHTML = '<span class="spinner"></span> –ü–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...';
        document.getElementById("downloadAllSection").style.display = "none";
        document.getElementById("musicTable").style.display = "none";

        const payload = {
            MusicName: query,
            ConnectionId: connectionId
        };
        
        fetch('/Music/FindMusic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error("Search error");
        })
        .catch(err => alert(err.message));
    });
</script>

</body>
</html>