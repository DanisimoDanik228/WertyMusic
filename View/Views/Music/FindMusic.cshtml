@model IEnumerable<Domain.Models.Music>

@{
    ViewData["Title"] = "–ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏";
}

<div class="container mt-4">
    <h2>–ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏</h2>

    <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è..." />
        <button class="btn btn-primary" type="button" id="btnSearch">–ù–∞–π—Ç–∏</button>
    </div>

    <div id="resultsInfo" class="alert alert-info" style="display:none;">
        –ù–∞–π–¥–µ–Ω–æ –ø–µ—Å–µ–Ω: <strong id="totalCount">0</strong>
        <span id="loadingStatus" class="ms-3">
            <span class="spinner-border spinner-border-sm" role="status"></span> –ü–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...
        </span>
    </div>

    <table class="table music-table mt-3">
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                <th>–†–µ—Å—É—Ä—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
        </thead>
        <tbody id="musicTableBody">
            <!-- Elements well be added here -->
        </tbody>
    </table>

    <div class="download-all mt-4" id="downloadAllSection" style="display:none;">
        <form asp-action="DownloadZip" method="post" id="downloadForm">
            <!-- Hidden field to pass connection ID -->
            <input type="hidden" name="connectionId" id="hiddenConnectionId" />
            
            <button type="submit" class="btn btn-success">
                üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ (<span id="btnCount">0</span>)
            </button>
        </form>
    </div>
</div>

<style>
    .music-row {
        animation: fadeIn 0.5s ease-in-out;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/musicHub") 
        .build();

    let musicCount = 0;

    connection.on("ReceiveMusic", function (song) {
        musicCount++;
        
        document.getElementById("resultsInfo").style.display = "block";
        document.getElementById("totalCount").innerText = musicCount;
        document.getElementById("btnCount").innerText = musicCount;
        document.getElementById("downloadAllSection").style.display = "block";

        const tbody = document.getElementById("musicTableBody");
        const row = `
            <tr class="music-row">
                <td>${song.musicName}</td>
                <td>${song.artistName}</td>
                <td><span class="badge bg-secondary">${song.siteSource}</span></td>
                <td>
                    <a href="${song.downloadUrl}" class="btn btn-sm btn-outline-primary" target="_blank">–°–∫–∞—á–∞—Ç—å</a>
                </td>
            </tr>`;
        
        tbody.insertAdjacentHTML('beforeend', row);
    });

    connection.on("SearchFinished", function () {
        document.getElementById("loadingStatus").innerHTML = "‚úÖ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω";
    });

    connection.on("ReceiveError", function (message) {
        alert("–û—à–∏–±–∫–∞: " + message);
    });

    connection.start().then(function () {
        console.log("SignalR Connected");
        document.getElementById("hiddenConnectionId").value = connection.connectionId;
    }).catch(err => console.error(err.toString()));

    document.getElementById("btnSearch").addEventListener("click", function () {
        const query = document.getElementById("searchInput").value;
        if (!query) return alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å");

        const connectionId = connection.connectionId;

        musicCount = 0;
        document.getElementById("musicTableBody").innerHTML = "";
        document.getElementById("resultsInfo").style.display = "block";
        document.getElementById("loadingStatus").innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ü–æ–∏—Å–∫...';
        document.getElementById("downloadAllSection").style.display = "none";

        const payload = {
            MusicName: query,
            ConnectionId: connectionId
        };
        
        fetch('/Music/FindMusic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–∏—Å–∫–∞");
        })
        .catch(err => alert(err.message));
    });
</script>